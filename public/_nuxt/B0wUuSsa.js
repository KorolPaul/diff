import Ce from"./DGu3cDrV.js";import{e as Te,u as Pe,c as $e,b as we,d as Se}from"./lFH7uUjQ.js";import{a6 as N,a7 as Fe,au as u,g as Ae,b as Oe,h as Ue,S as te,r as R,x as f,u as Be,w as ae,a5 as Le,j as oe,o as re,l as x,z as ne,k as m,y as $,m as r,t as Ee,A as Ne,B as se,Q as Ve,D as je,F as Me,ah as V}from"./Pd6RrLp1.js";import{_ as Ge}from"./Bh9jfPsV.js";import{_ as We}from"./2WVDaFKk.js";import{a as qe}from"./BoW1LxkV.js";import{u as ce}from"./CiYsyl20.js";import{u as He}from"./BSts32E-.js";import{s as j,a as ze,t as Ye,p as Ke,b as Qe,c as Xe}from"./DV533Gpo.js";import{C as Je}from"./BslN7nPp.js";const Ze=`${Fe}cart/checkout`,M="repayment",G={contactID:"",checkoutID:""};u.object({data:u.object({checkout:u.object({id:u.string(),order:u.object({config:u.object({paymentTypes:u.array(Xe)}),crmId:u.string(),crmNumber:u.string(),isPaid:u.boolean(),isRepaymentAvailable:u.boolean(),isTimeLeftForRepayment:u.boolean(),orderStatus:u.string(),payment:Ke,paymentStatus:u.string(),products:u.array(Qe),total:Ye,user:ze})})})});const W=(_,p="")=>`${Ze}/${_}${p?`/${p}`:""}`,le={async updateRepeatPayment(_,p=G){var n,h;const{patch:a,setHeader:y}=N();j(y);const v=W(p.checkoutID,M),l=p.contactID?{contact_id:p.contactID}:{},{data:D,error:I}=await a(v,_,{params:l});return{data:D.value,error:(h=(n=I.value)==null?void 0:n.data)==null?void 0:h.errors}},async getOrderData(_=G){var I,n;const{get:p,setHeader:a}=N();j(a);const y=W(_.checkoutID,M),v=_.contactID?{contact_id:_.contactID}:{},{data:l,error:D}=await p(y,{params:v});return{data:l.value,error:(n=(I=D.value)==null?void 0:I.data)==null?void 0:n.errors}},async submitRepeatPayment(_,p=G){var n,h;const{post:a,setHeader:y}=N();j(y);const v=W(p.checkoutID,M),l=p.contactID?{contact_id:p.contactID}:{},{data:D,error:I}=await a(v,_,{params:l});return{data:D.value,error:(h=(n=I.value)==null?void 0:n.data)==null?void 0:h.errors}}},et={class:"repeat-payment-modal_wrapper"},tt={class:"repeat-payment-modal_header"},at={class:"repeat-payment-modal_content"},ot={class:"repeat-payment-modal_payment-groups"},rt={class:"repeat-payment-modal_payment-groups-content"},nt={key:0,class:"repeat-payment-modal_tooltip"},st={class:"repeat-payment-modal_tooltip-text"},ct={class:"repeat-payment-modal_products"},lt={class:"repeat-payment-modal_products-content"},dt={class:"repeat-payment-modal_bottom-bar"},it={class:"repeat-payment-modal_submit"},ut={class:"repeat-payment-modal_total"},pt={class:"repeat-payment-modal_total-text"},mt={class:"repeat-payment-modal_total-price"},Rt={__name:"repeat-payment-modal",props:{checkoutId:{type:String,default:""},contactId:{type:String,default:""},isRepeatModalOpened:{type:Boolean,default:!1},order:{type:Object,default:()=>{},required:!0},products:{type:Array,default:()=>[]}},emits:["close","updateOrder"],setup(_,{emit:p}){const a=_,y=p,v=Ae(),{t:l}=Oe(),{formatPriceWithSpaces:D}=He(),{userDevicesTotalPrice:I}=Ue(),n=te({text:"",buttonText:"",title:"",redirectUrl:"",actionAfterRedirect:null,shouldBeAgreed:!1,onClose:null}),h=R(!1),de=f(()=>{var e,t;return(t=(e=a.order)==null?void 0:e.payment)==null?void 0:t.currency}),S=f(()=>{var e,t;return(t=(e=a.order)==null?void 0:e.total)==null?void 0:t.total_price_with_discount}),ie=f(()=>{var e,t,c,o;return((t=(e=a.order)==null?void 0:e.total)==null?void 0:t.total_trade_in_grade_price_with_topup)-((o=(c=a.order)==null?void 0:c.total)==null?void 0:o.total_trade_in_grade_price)}),T=f(()=>{var e,t;return((t=(e=a.order)==null?void 0:e.total)==null?void 0:t.total_trade_in_grade_price)||Number(I.value)}),ue=f(()=>T.value?S.value>T.value?S.value-T.value-ie.value:1:S.value),w=f(()=>a.isRepeatModalOpened),{savePaymentData:F}=Pe(),{isLoading:pe,startLoading:q,stopLoading:H}=ce(),{isLoading:z,startLoading:me,stopLoading:_e}=ce(),ye=Be(),{refactorPaymentData:he,filterPayments:ve}=Te(),P=R(a.order),A=R(null),b=te({payment_type:null,selectCredit:null,credit:null}),O=R(!0),U=R(!0),B=R(""),Y=R({}),L=qe(),fe=f(()=>{var e,t;return(t=(e=a.order)==null?void 0:e.payment)!=null&&t.is_online_payment?l("repeat_payment_online_title"):l("repeat_payment_title")}),Ie=f(()=>{var e;return(e=ye.name)==null?void 0:e.includes("checkout")}),E=f(()=>{var e,t;return ve((t=(e=a.order)==null?void 0:e.config)==null?void 0:t.payment_types)}),K=e=>{Ie.value?(y("updateOrder",e),y("close")):V(v.$localeRoute({path:`/checkout/${a.checkoutId}`,query:{contact_id:a.contactId}}))},be=(e,t)=>{if(!(t!=null&&t.url)||!(t!=null&&t.type))K(e);else{const c=`/checkout/${a.checkoutId}/redirect?contact_id=${a.contactId}`;V(v.$localeRoute({path:c}))}},ke=async()=>{var e;try{q();const{data:t}=await Je.getOrderData({checkoutID:a.checkoutId,contactID:a.contactId}),c=(e=t==null?void 0:t.data)==null?void 0:e.checkout;K(c)}catch(t){console.error(t)}finally{H(),y("close")}},Q=e=>{switch(e){case"order":ke();break}},X=(e="",t="")=>{V(v.$localeRoute({path:`/checkout/${e}`,query:{contact_id:t}}))},J=async({fetchData:e,checkoutID:t,contactID:c,config:o})=>{try{return await e()}catch(s){console.error(s);let d="default";const i={...o,onClose:()=>(o==null?void 0:o.onClose)&&o.onClose(d)};switch(!0){case(s==null?void 0:s.order):d="order",n.title=l("repeat_payment_order_error_title"),n.text=l("repeat_payment_order_error_text"),n.buttonText=l("repeat_payment_order_error_btn_text"),n.redirectUrl=`/checkout/${t}?contact_id=${c}`,n.onClose=i==null?void 0:i.onClose,h.value=!0;break;case(s==null?void 0:s.payment):d="payment",X(t,c);break;case(s==null?void 0:s.user):return null;default:n.title=l("service_error_title"),n.text=l("service_error_text"),n.buttonText=l("service_error_btn_text"),n.onClose=i==null?void 0:i.onClose,h.value=!0;break}return o.onError&&(o==null||o.onError(d)),null}finally{o.onFinally&&(o==null||o.onFinally())}},De=e=>{var t;if((t=a.order)!=null&&t.is_repayment_available)return J({fetchData:async()=>{var s,d;me();const{data:c,error:o}=await le.updateRepeatPayment(e,{checkoutID:a.checkoutId,contactID:a.contactId});if(o)throw o;return P.value=(d=(s=c==null?void 0:c.data)==null?void 0:s.checkout)==null?void 0:d.order,P.value},checkoutID:a.checkoutId,contactID:a.contactId,config:{onFinally:()=>_e(),onClose:Q}})},ge=()=>J({fetchData:async()=>{var g,k,C,Z,ee;if(z.value||((g=A.value)==null||g.validateDefaultForm(),L.value.$reset(),L.value.$touch(),L.value.$invalid))return;q();const e=((k=A.value)==null?void 0:k.createSortAdditionalFields())||{},c={...((C=b==null?void 0:b.payment_type)==null?void 0:C.type)==="credit"?b.selectCredit:b.payment_type,form:{...Y.value,values:e}},{data:o,error:s}=await le.submitRepeatPayment({payment:c},{checkoutID:a.checkoutId,contactID:a.contactId});if(s)throw s;const d=(Z=o==null?void 0:o.data)==null?void 0:Z.checkout,i=(ee=o==null?void 0:o.data)==null?void 0:ee.payment;if((i==null?void 0:i.status)==="error"){X();return}be(d,i)},checkoutID:a.checkoutId,contactID:a.contactId,config:{onFinally:()=>{H()},onClose:Q}}),Re=e=>{b.payment_type=e.payment_type,b.selectCredit=e.selectCredit,b.credit=e.credit,Y.value=e.formConfig},xe=()=>{var c,o;U.value=!0,O.value=!0;const e=a.order.payment;if(B.value=l(`payment_${e==null?void 0:e.type}`),!((c=E.value)==null?void 0:c.find(s=>(s==null?void 0:s.name)===(e==null?void 0:e.type)))){const s=(o=E.value)==null?void 0:o.find(d=>{var i,g;return(d==null?void 0:d.group)===(e==null?void 0:e.group)||((g=(i=d==null?void 0:d.credit_params)==null?void 0:i.programs)==null?void 0:g.find(k=>(k==null?void 0:k.id)===(e==null?void 0:e.credit_program_id)))});!s||!e.group?U.value=!1:(O.value=!1,F(s))}};return ae(()=>a.order,e=>{P.value=e}),ae(()=>a.isRepeatModalOpened,()=>{var e;P.value=a.order,F(he((e=a.order)==null?void 0:e.payment)),xe()}),Le(()=>{F(null)}),(e,t)=>{const c=Ce,o=$e,s=we,d=Ne,i=Ge,g=We,k=Se;return re(),oe(Me,null,[x(g,Ve({modelValue:r(w),"onUpdate:modelValue":t[0]||(t[0]=C=>je(w)?w.value=C:null)},{...e.$attrs},{"full-height":"","modal-class":"repeat-payment-modal","max-width":1060,"onUpdate:modelValue":t[1]||(t[1]=C=>y("close"))}),{default:ne(()=>[m("div",et,[m("p",tt,$(r(l)(r(fe))),1),m("div",at,[m("div",ot,[m("div",rt,[r(U)?Ee("",!0):(re(),oe("div",nt,[x(c,{class:"repeat-payment-modal_tooltip-icon"}),m("span",st,$(r(l)(r(B))),1)])),x(o,{ref_key:"paymentRef",ref:A,currency:r(de),"current-cart":r(P),"is-available-group-type":r(O),"is-opened":r(w),"is-title-shown":!1,loading:r(z),"old-payment-type-value":r(B),"payment-config":r(E),onUpdateState:Re,onUpdate:De},null,8,["currency","current-cart","is-available-group-type","is-opened","loading","old-payment-type-value","payment-config"])])]),m("div",ct,[m("div",lt,[x(s,{order:_.order,"is-trade-in":!!r(T),"show-total":!1,"max-width":"","no-margin-bottom":"","is-repeat-payment":""},null,8,["order","is-trade-in"])])])]),m("div",dt,[m("div",it,[x(d,{class:"repeat-payment-modal_submit-button",loading:r(pe),onClick:ge},{default:ne(()=>[se($(r(l)("confirm")),1)]),_:1},8,["loading"])]),m("div",ut,[m("span",pt,$(e.$t(r(T)?"preliminary_total_cost":"total")),1),m("span",mt,[se($(r(D)(r(ue)))+" ",1),x(i,{currency:"","use-default":""})])])])])]),_:1},16,["modelValue"]),x(k,{"is-modal-opened":r(h),"button-text":r(n).buttonText,text:r(n).text,title:r(n).title,"redirect-url":r(n).redirectUrl,"action-after-redirect":r(n).actionAfterRedirect,"should-be-agreed":r(n).shouldBeAgreed,onOnClose:r(n).onClose,onClose:t[2]||(t[2]=C=>h.value=!1)},null,8,["is-modal-opened","button-text","text","title","redirect-url","action-after-redirect","should-be-agreed","onOnClose"])],64)}}};export{le as R,Rt as _};
