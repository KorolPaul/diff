import{a6 as i,a7 as l,g as st,b as at,G as nt,u as ot,a9 as A}from"./Pd6RrLp1.js";import{u as rt}from"./UMgXyzVE.js";import{u as ct,a as it}from"./C3MdYnyV.js";import{C as $}from"./DV533Gpo.js";const ut=`${l}signup`,lt=`${l}login`,dt=`${l}unregistered/signin`,ht=`${l}forgot`,pt=`${l}confirm`,gt=`${l}phone/resend`,ft=`${l}validate-reset-code`,mt=`${l}logout`,E=`${l}profile`,yt=`${l}send-code`,vt=`${l}check-login`,d={async b2cSignup(n){const{post:s}=i();return s(ut,n)},async signIn(n){const{post:s}=i();return s(lt,n)},async unregisterSignIn(n){const{post:s}=i();return s(dt,n)},async forgotPassword(n){const{post:s}=i();return s(ht,n)},async confirmAccount(n){const{post:s}=i();return s(pt,{verification_code:n})},async sendCode(n){const{post:s}=i();return s(yt,{login:n})},async resendCode(n){const{post:s}=i();return s(gt,{login:n})},async checkCode(n){const{post:s}=i();return s(ft,n)},async checkExistUser(n){const{post:s}=i();return s(vt,{login:n})},async cabinet(){const{get:n}=i(),{data:s}=await n(E);return{data:s.value.data}},async logout(){const{get:n}=i(),{data:s}=await n(mt);return{data:s.value}},async deleteAccount(n){const{remove:s}=i();return s(`${E}/${n}`)},async loginWithSocialMedia(n,s){const{get:g}=i(),{data:k}=await g(`${l}login/${n}/callback?code=${s}`);return{data:k.value}},async loginWithSocialProvider(n){const{get:s}=i(),{data:g}=await s(`${l}login/${n}`);return{data:g.value}},async removeSocialProvider(n){const{remove:s}=i();return s(`${l}profile/social-accounts/${n}`)}},R=`${l}profile`,_t={async updateProfile(n){const{put:s}=i();return s(R,n)},async patchProfile(n){const{patch:s}=i();return s(R,n)}},bt=()=>{const n=st(),{t:s}=at(),{setHeader:g,deleteHeader:k}=i(),{setUser:p,setMainUserAddress:b,mainUserAddress:B,setUserRequestStatus:W,isUnregisterOrder:F,getUser:f}=rt(),{pushMindBoxEvent:z}=it(),{setCart:C,fetchCart:w}=ct(),H=nt(),P=ot(),L=e=>{if(e.length===0)return[];const t=[];return e.email&&e.email.forEach(a=>{a.includes("The selected email is invalid")&&t.push({name:"email",message:s("selected_email_not_exist")})}),e.message&&e.message.forEach(a=>{a.includes("User invalid password")&&t.push({name:"password",message:s("typed_password_invalid")})}),t.length===0&&t.push(s("form_data_invalid")),t},O=e=>{const t=[];return e.email?(e.email.forEach(a=>{a==="email_not_use_partner_company"&&t.push(s("email_not_use_partner_company"))}),t.length===0&&t.push(s("validation_email_exist"))):e.phone?t.push(Array.isArray(e.phone)?e.phone[0]:s("validation_phone_exist")):Array.isArray(e==null?void 0:e.type)&&t.push(e.type[0]),t},S=e=>{var u;const{status:t,data:a}=e,r=[],o=(u=a==null?void 0:a.errors)!=null&&u.verification_code?a.errors.verification_code:[];switch(t){case 404:case 422:o!=null&&o.length?r.push(...o):a!=null&&a.message?r.push(a.message):r.push(s("form_code_invalid"));break}return r},v=(e,t)=>{const{statusCode:a,data:r}=e,o=[],u=t?O(r):L(r==null?void 0:r.errors),c=u.find(_=>_.toLowerCase().includes("phone is not supported"));switch(a){case 404:o.push(s("form_login_not_exist."));break;case 422:c?o.push(s("phone_is_not_supported")):o.push(...u);break;default:o.push(s(r.message));break}return o},m=()=>{A("Auth-token").value=null},q=()=>{A("front-cart-token").value=null},y=()=>{delete k("Authorization")},x=async()=>{try{const e=await d.cabinet(),t=(e==null?void 0:e.data)??!1;t&&p(t,!1),b(t==null?void 0:t.addresses)}catch(e){e.response&&e.response.status===401&&(m(),y()),console.log(e)}finally{W(!0)}},G=e=>{var t;(t=navigator.serviceWorker)!=null&&t.controller&&navigator.serviceWorker.controller.postMessage(e)},I=()=>{const e=new Date;return e.setTime(e.getTime()+365*24*60*60*1e3),e},N=(e,t)=>{const a=A("Auth-token",t?{maxAge:I(),path:"/"}:{path:"/"});a.value=e},U=(e,t=!0)=>{g("Authorization",`Bearer ${e}`),N(e,t)},X=async e=>{var a;const t=await d.b2cSignup(e);return{status:t.status,user:(a=t.data)==null?void 0:a.data,error:t.error}},j=async(e,t=!0)=>{var u,c,_;const a=await d.signIn(e),r=a.data.value,o=(u=a.status)==null?void 0:u.value;if(o==="success"&&r&&(U((c=r==null?void 0:r.data)==null?void 0:c.token,t),setTimeout(async()=>{var h;await x(),B.value||b(((h=f.value)==null?void 0:h.addresses)||null),await w(),z("webCustomerAuth",f.value.uuid)})),o==="error"){const h=(_=a==null?void 0:a.error)==null?void 0:_.value;return m(),y(),v({data:h==null?void 0:h.data,statusCode:h==null?void 0:h.statusCode})}return{status:o,user:f.value}},J=async(e,t)=>{var a,r;try{if(t)return p({...t.data.data.cart.user,client_type:"unregistered"}),await w(),{status:t.status,user:t.data.data.cart.user};const o=await d.unregisterSignIn(e);return o.status==="success"&&((a=o.data)!=null&&a.data)&&(p(o.data.data),await w()),{status:o.status,user:(r=o.data)==null?void 0:r.data}}catch{return m(),y(),[]}},K=async(e,t)=>{var a;try{if((await _t.patchProfile(e)).status===200){const o={old_user_id:t.contact_id},u=await $.updateUserCart(o);p({...t,email:e.email,name:e.name,lastname:e.lastname,subscription:e.subscription,contact_id:o.old_user_id}),C((a=u==null?void 0:u.data)==null?void 0:a.data.cart)}else p({...t,email:e.email,name:e.name,lastname:e.lastname,subscription:e.subscription});return{status:200}}catch(r){const{status:o,data:u}=r.response,c=[];switch(o){case 422:u.errors.email&&c.push(s("validation_email_exist"));break}return c}},T=async e=>{const t=await d.sendCode(e);if((t==null?void 0:t.status.value)==="success")return t;const r=t==null?void 0:t.error;return S({status:r.value.statusCode,data:r.value.data})},Q=async e=>{try{const t=await d.checkExistUser(e),{status:a}=t;switch(+a){case 204:return!0;default:return!1}}catch(t){return console.log(t),!1}},Y=async e=>{await T(e)},Z=async e=>{try{return await X(e)}catch(t){return v(t,!0)}},V=async e=>{try{return(await d.forgotPassword({login:e})).status}catch(t){const{status:a,data:r}=t.response,o=[];if(+`${a}`[0]==4&&(r!=null&&r.message))return o.push(r.message),o;switch(a){case 422:o.push(s("selected_phone_is_invalid"));break;case 404:o.push(s("form_phone_not_exist"));break}return o}},D=async e=>{try{const t=await d.checkCode(e),{status:a}=t;return a}catch(t){return console.log(t),null}},tt=async e=>{try{return{status:(await d.confirmAccount(e)).status,user:f.value}}catch(t){return S(t)}},et=async()=>{A("Auth-token").value&&await x()},M=async(e=!0,t=!0)=>{var a,r,o,u;try{if(f.value.client_type!=="unregistered")try{await d.logout();const{data:c}=await $.deleteAllProductFromCart();(a=c==null?void 0:c.data)!=null&&a.cart&&C((r=c==null?void 0:c.data)==null?void 0:r.cart),window.location.reload()}catch(c){if(t)throw c}else{const{data:c}=await $.getCart();(o=c==null?void 0:c.data)!=null&&o.cart&&C((u=c==null?void 0:c.data)==null?void 0:u.cart)}q(),m(),y(),p(null),e&&(P.name.includes("profile")||P.name.includes("account")||P.name.includes("checkout"))&&H.push(n.$localeRoute({path:"/"}))}catch{}};return{signIn:j,signUp:Z,checkExistUser:Q,shareAuthDataToAllTabs:G,setBearerToken:U,unregisterSignIn:J,forgotByPhoneOrEmail:V,confirmAccount:tt,resendCode:Y,autoAuth:et,logout:M,deleteBearerToken:y,removeTokenInCookies:m,logoutIfUserUnregister:async()=>{F.value&&await M(!1)},editUnregisterUser:K,checkCodeValidation:D,deleteAccount:async e=>{try{const t=await d.deleteAccount(e);return t.status.value==="error"?v({data:t.error.value.data,statusCode:t.error.value.statusCode},!1):t}catch(t){return v(t,!1)}},sendCode:T,getMaxCookieAge:I}};export{_t as A,d as a,bt as u};
